<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            position: relative;
        }

        #map {
            height: calc(100% - 40px);
        }

        #developmentNotice {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        #closeButton {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        .leaflet-control {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
        }

        .leaflet-control-layers {
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div id="developmentNotice">
        <span id="closeButton">&times;</span>
        <p>O mapa está em desenvolvimento. Alguns recursos podem não estar disponíveis.<br>Equipa: Baker Telekom</p>
        <p>Por favor, relate qualquer problema diretamente a @luiisbaker pelo Telegram.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var closeButton = document.getElementById('closeButton');
            var developmentNotice = document.getElementById('developmentNotice');

            closeButton.addEventListener('click', function () {
                developmentNotice.style.display = 'none';
            });

            var map = L.map('map').setView([39.3999, -8.2245], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var markerColors = {
                '01': 'blue',   // Vodafone
                '02': 'green',  // DIGI
                '03': 'red',    // NOS
                '06': 'orange'  // MEO
            };

            var frequencyMapping = {
                '01': { '9360': 'B28', '6300': 'B20', '3525': 'B8', '1300': 'B3', '103': 'B1', '2950': 'B7', '37900': 'B38' },
                '02': { '3475': 'B8', '1925': 'B3', '2275': 'B7', '2775': 'B7', '38150': 'B38' },
                '03': { '6400': 'B20', '300': 'B1', '1500': 'B3', '3150': 'B7' },
                '06': { '6200': 'B20', '3749': 'B8', '1700': 'B3', '500': 'B1', '525': 'B1', '3350': 'B7' }
            };

            var markers = {};
            var markerCluster = L.markerClusterGroup();

            var debugMode = false;
            var selectedOperator = 'all'; // Operadora inicialmente selecionada

            function addMarker(loc, mnc, apiResponse) {
                const coords = `${loc.latitude},${loc.longitude}`;

                if (!markers[coords]) {
                    markers[coords] = { latLng: [loc.latitude, loc.longitude], mncs: [], technology: {}, debugInfo: [] };
                }

                if (!markers[coords].mncs.includes(mnc)) {
                    markers[coords].mncs.push(mnc);
                }

                if (!markers[coords].technology[mnc]) {
                    markers[coords].technology[mnc] = { '2G': false, '3G': false, '4G': [] };
                }

                if (!markers[coords].technology[mnc][loc.technology]) {
                    markers[coords].technology[mnc][loc.technology] = true;
                }

                if (loc.frequency && !markers[coords].technology[mnc]['4G'].includes(loc.frequency.toString())) {
                    const band = frequencyMapping[mnc] && frequencyMapping[mnc][loc.frequency.toString()];
                    if (band && !markers[coords].technology[mnc]['4G'].includes(band)) { // Verifica se a banda já está presente
                        markers[coords].technology[mnc]['4G'].push(band);
                    }
                }

                if (debugMode) {
                    markers[coords].debugInfo.push(apiResponse);
                }
            }

            function generatePopupContent(markerData) {
                var popupContent = '<b>Operadoras neste suporte:</b><br>';
                var allFrequenciesZero = true; // Flag para verificar se todas as frequências são zero

                Object.entries(markerData.technology).forEach(([mnc, techInfo]) => {
                    if (techInfo['2G'] || techInfo['3G'] || techInfo['4G'].length > 0) {
                        const operatorName = { '01': 'Vodafone', '02': 'DIGI', '03': 'NOS', '06': 'MEO' }[mnc];
                        popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;${operatorName}:<br>`;

                        if (techInfo['2G']) {
                            popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2G capturado<br>`;
                        }

                        if (techInfo['3G']) {
                            popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3G capturado<br>`;
                        }

                        if (techInfo['4G'].length > 0) {
                            const uniqueBands = [...new Set(techInfo['4G'])]; // Remove bandas duplicadas
                            popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Frequências 4G: ${uniqueBands.join(', ')}<br>`;
                            // Verifica se há pelo menos uma frequência 4G diferente de 0
                            if (techInfo['4G'].some(band => band !== '0')) {
                                allFrequenciesZero = false;
                            }
                        }
                    }
                });

                // Adiciona a mensagem "Sinal 4G detetado mas dados incompletos" apenas se todas as frequências 4G forem zero
                if (allFrequenciesZero) {
                    popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;Sinal 4G detetado mas dados incompletos<br>`;
                }

                // Adiciona informações de depuração
                if (debugMode && markerData.debugInfo && markerData.debugInfo.length > 0) {
                    popupContent += '<br><b>Debug API:</b><br>';
                    markerData.debugInfo.forEach(info => {
                        popupContent += `&nbsp;&nbsp;&nbsp;&nbsp;${info}<br>`;
                    });
                }

                return popupContent;
            }

            function createMarkers() {
                markerCluster.clearLayers();

                Object.values(markers).forEach(markerData => {
                    if (selectedOperator === 'all' || markerData.mncs.includes(selectedOperator)) {
                        const popupContent = generatePopupContent(markerData);
                        const marker = L.marker(markerData.latLng, {
                            icon: L.icon({
                                iconUrl: 'https://cdn.ibakerserver.pt/9Od0lAn.png',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15],
                                popupAnchor: [0, -15]
                            }),
                            title: 'Operadoras neste suporte'
                        }).bindPopup(popupContent);

                        // Adiciona o evento de clique ao marcador
                        marker.on('click', function () {
                            this.openPopup();
                        });

                        markerCluster.addLayer(marker);
                    }
                });

                map.addLayer(markerCluster);
            }

            function fetchData(mnc) {
                fetch(`https://netmonsterpt.ibakerserver.pt/api/cell/${mnc}/268`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(loc => {
                            addMarker(loc, mnc, JSON.stringify(loc));
                        });
                        createMarkers();
                    })
                    .catch(error => console.error(error));
            }

            ['01', '02', '03', '06'].forEach(mnc => {
                fetchData(mnc);
            });

            map.on('moveend', function () {
                createMarkers();
            });

            // Adiciona controle de filtro por operadora
            var operatorFilterControl = L.control({ position: 'topright' });

            operatorFilterControl.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = `
                    <select id="operatorFilter">
                        <option value="all">Todas as Operadoras</option>
                        <option value="01">Vodafone</option>
                        <option value="02">DIGI</option>
                        <option value="03">NOS</option>
                        <option value="06">MEO</option>
                    </select>
                `;
                return div;
            };

            operatorFilterControl.addTo(map);

            // Adiciona evento para atualizar o filtro ao alterar a seleção
            document.getElementById('operatorFilter').addEventListener('change', function (event) {
                selectedOperator = event.target.value;
                filterMarkers(selectedOperator);
            });

            // Função para filtrar os marcadores de acordo com a operadora selecionada
            function filterMarkers(operator) {
                markerCluster.clearLayers(); // Limpa todos os marcadores

                Object.values(markers).forEach(markerData => {
                    if (operator === 'all' || markerData.mncs.includes(operator)) {
                        const popupContent = generatePopupContent(markerData);
                        const marker = L.marker(markerData.latLng, {
                            icon: L.icon({
                                iconUrl: 'https://cdn.ibakerserver.pt/9Od0lAn.png',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15],
                                popupAnchor: [0, -15]
                            }),
                            title: 'Operadoras neste suporte'
                        }).bindPopup(popupContent);

                        markerCluster.addLayer(marker);
                    }
                });

                map.addLayer(markerCluster);
            }

            // Adiciona controle de Modo Debug
            var debugControl = L.control({ position: 'topright' });

            debugControl.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = '<input type="checkbox" id="debugModeCheckbox">' +
                    '<label for="debugModeCheckbox">Modo Debug</label>';
                return div;
            };

            debugControl.addTo(map);

            // Atualizando o Modo Debug ao alterar a caixa de seleção
            document.getElementById('debugModeCheckbox').addEventListener('change', function (event) {
                debugMode = event.target.checked;
                createMarkers();
            });
        });
    </script>
</body>

</html>
